<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Prof.&nbsp;Niamh Cahill (she/her)">

<title>Bayesian Data Analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
</head>

<body>

<div id="quarto-search-results"></div>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#what-do-we-know-so-far" id="toc-what-do-we-know-so-far" class="nav-link active" data-scroll-target="#what-do-we-know-so-far">What do we know so far?</a></li>
  <li><a href="#simulation-based-inference-recap" id="toc-simulation-based-inference-recap" class="nav-link" data-scroll-target="#simulation-based-inference-recap">Simulation-based inference (recap)</a></li>
  <li><a href="#markov-chain-monte-carlo-mcmc" id="toc-markov-chain-monte-carlo-mcmc" class="nav-link" data-scroll-target="#markov-chain-monte-carlo-mcmc">Markov Chain Monte Carlo (MCMC)</a></li>
  <li><a href="#a-simple-markov-chain-example" id="toc-a-simple-markov-chain-example" class="nav-link" data-scroll-target="#a-simple-markov-chain-example">A simple Markov chain example</a></li>
  <li><a href="#stationary-distributions" id="toc-stationary-distributions" class="nav-link" data-scroll-target="#stationary-distributions">Stationary Distributions</a></li>
  <li><a href="#creating-the-markov-chain" id="toc-creating-the-markov-chain" class="nav-link" data-scroll-target="#creating-the-markov-chain">Creating the Markov Chain</a></li>
  <li><a href="#mcmc-the-metropolis-algorithm" id="toc-mcmc-the-metropolis-algorithm" class="nav-link" data-scroll-target="#mcmc-the-metropolis-algorithm">MCMC: The Metropolis Algorithm</a></li>
  <li><a href="#metropolis-algorithm-for-the-happiness-example" id="toc-metropolis-algorithm-for-the-happiness-example" class="nav-link" data-scroll-target="#metropolis-algorithm-for-the-happiness-example">Metropolis Algorithm for the Happiness example</a></li>
  <li><a href="#metropolis-algorithm-for-the-happiness-example-1" id="toc-metropolis-algorithm-for-the-happiness-example-1" class="nav-link" data-scroll-target="#metropolis-algorithm-for-the-happiness-example-1">Metropolis Algorithm for the Happiness example</a></li>
  <li><a href="#trace-plot-and-chains-for-theta" id="toc-trace-plot-and-chains-for-theta" class="nav-link" data-scroll-target="#trace-plot-and-chains-for-theta">Trace plot and chains for <span class="math inline">\(\theta\)</span></a></li>
  <li><a href="#metropolis-algorithm-for-the-kid-iq-example" id="toc-metropolis-algorithm-for-the-kid-iq-example" class="nav-link" data-scroll-target="#metropolis-algorithm-for-the-kid-iq-example">Metropolis algorithm for the Kid IQ example</a></li>
  <li><a href="#bayesian-inference-for-mu-and-sigma-the-kid-iq-example" id="toc-bayesian-inference-for-mu-and-sigma-the-kid-iq-example" class="nav-link" data-scroll-target="#bayesian-inference-for-mu-and-sigma-the-kid-iq-example">Bayesian Inference for <span class="math inline">\(\mu\)</span> <u>and</u> <span class="math inline">\(\sigma\)</span> (the Kid IQ example)</a></li>
  <li><a href="#mcmc-the-gibbs-sampler" id="toc-mcmc-the-gibbs-sampler" class="nav-link" data-scroll-target="#mcmc-the-gibbs-sampler">MCMC: The Gibbs Sampler</a></li>
  <li><a href="#remember-those-complete-conditional-distributions" id="toc-remember-those-complete-conditional-distributions" class="nav-link" data-scroll-target="#remember-those-complete-conditional-distributions">Remember those complete conditional distributions?</a></li>
  <li><a href="#gibbs-sampling-algorithm-for-the-kid-iq-example" id="toc-gibbs-sampling-algorithm-for-the-kid-iq-example" class="nav-link" data-scroll-target="#gibbs-sampling-algorithm-for-the-kid-iq-example">Gibbs sampling algorithm for the Kid IQ example</a></li>
  <li><a href="#output-from-mcmc" id="toc-output-from-mcmc" class="nav-link" data-scroll-target="#output-from-mcmc">Output from MCMC</a></li>
  <li><a href="#output-from-mcmc-trace-plots" id="toc-output-from-mcmc-trace-plots" class="nav-link" data-scroll-target="#output-from-mcmc-trace-plots">Output from MCMC: trace plots</a></li>
  <li><a href="#output-from-mcmc-joint-parameter-plots" id="toc-output-from-mcmc-joint-parameter-plots" class="nav-link" data-scroll-target="#output-from-mcmc-joint-parameter-plots">Output from MCMC: joint parameter plots</a></li>
  <li><a href="#output-from-mcmc-density-plots-and-summaries" id="toc-output-from-mcmc-density-plots-and-summaries" class="nav-link" data-scroll-target="#output-from-mcmc-density-plots-and-summaries">Output from MCMC: density plots and summaries</a></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="4-MCMC.html"><i class="bi bi-file-slides"></i>RevealJS</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Bayesian Data Analysis</h1>
<p class="subtitle lead">MCMC</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Prof.&nbsp;Niamh Cahill (she/her) </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="what-do-we-know-so-far" class="level2" style="font-size: 70%;">
<h2 style="font-size: 70%;" class="anchored" data-anchor-id="what-do-we-know-so-far">What do we know so far?</h2>
<p>We can use Bayes’ rule to get posterior densities</p>
<ul>
<li><p>Example for single parameter Normal - <span class="math inline">\(\mu\)</span></p>
<ul>
<li><span class="math inline">\(p(\mu|y) \propto p(y|\mu)p(\mu)\)</span></li>
</ul></li>
<li><p>Example for single parameter Normal - <span class="math inline">\(\tau\)</span></p>
<ul>
<li><span class="math inline">\(p(\tau|y) \propto p(y|\tau)p(\tau)\)</span></li>
</ul></li>
<li><p>We could also do this for multiple parameters</p>
<ul>
<li><span class="math inline">\(p(\mu, \tau|y) \propto p(y|\mu,\tau)p(\mu,\tau)\)</span></li>
</ul></li>
</ul>
<p>BUT…</p>
<ul>
<li><p>Realistic problems with multiple parameters, data points, and common choices of priors don’t get a closed-form expression for <span class="math inline">\(p(\mu, \tau|y)\)</span></p></li>
<li><p>Sampling to the rescue!!</p></li>
</ul>
</section>
<section id="simulation-based-inference-recap" class="level2" style="font-size: 70%;">
<h2 style="font-size: 70%;" class="anchored" data-anchor-id="simulation-based-inference-recap">Simulation-based inference (recap)</h2>
<ul>
<li><p>The general idea in simulation-based inference: We can make inference about a parameter <span class="math inline">\(\theta\)</span> or <span class="math inline">\(\mu\)</span> or <span class="math inline">\(\tau\)</span> , using a sample e.g., <span class="math inline">\(\{\theta^{(1)}\ldots\theta^{(S)}\}\)</span>, from its probability distribution.</p></li>
<li><p>Assessing the properties of a target (e.g., posterior) distribution by generating representative samples is called Monte Carlo simulation.</p></li>
<li><p>Based on the law of large numbers we know that:</p>
<p><span class="math inline">\(\frac{1}{S}\sum_{s=1}^{S}\theta^{(s)} = E(\theta)\)</span></p>
<p>as sample size <span class="math inline">\(S \to \infty\)</span></p>
<ul>
<li>The error in the MC approximation goes to zero as <span class="math inline">\(S \to \infty\)</span> because <span class="math inline">\(\frac{var(\theta)}{S} \to 0\)</span></li>
</ul></li>
<li><p>Just about any aspect of the distribution of <span class="math inline">\(\theta\)</span> can be approximated arbitrarily exactly with a large enough Monte Carlo sample, e.g.,</p>
<ul>
<li>the <span class="math inline">\(\alpha\)</span>-percentile of the distribution of <span class="math inline">\(\theta\)</span></li>
<li><span class="math inline">\(Pr(\theta \geq x)\)</span> for any constant <span class="math inline">\(x\)</span></li>
</ul></li>
</ul>
</section>
<section id="markov-chain-monte-carlo-mcmc" class="level2" style="font-size: 70%;">
<h2 style="font-size: 70%;" class="anchored" data-anchor-id="markov-chain-monte-carlo-mcmc">Markov Chain Monte Carlo (MCMC)</h2>
<p>We’ve already discussed Monte Carlo sampling. Now we’re going to consider Markov Chain Monte Carlo (MCMC) sampling. MCMC algorithms are used for sampling from a target distribution.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Markov Chain
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><p>Any process in which each step has no memory of states before the current state is called a (first-order) Markov process and a sucession of such steps is a Markov chain.</p></li>
<li><p>The stationary distribution of the Markov chain is the target distribution.</p></li>
</ul>
</div>
</div>
<p>Using MCMC we can construct a set of samples from an unknown target (e.g., posterior) distribution.</p>
</section>
<section id="a-simple-markov-chain-example" class="level2" style="font-size: 70%;">
<h2 style="font-size: 70%;" class="anchored" data-anchor-id="a-simple-markov-chain-example">A simple Markov chain example</h2>
<p>What is the probability of sunny <span class="math inline">\(P(S)\)</span> and rainy <span class="math inline">\(P(R)\)</span> weather?</p>
<div class="columns">
<div class="column" style="width:50%;">
<p><img src="images/rainy-sunny-weather-clouds-sun-rainbow-92959121.jpg.webp" class="img-fluid"></p>
</div><div class="column" style="width:50%;">
<p>Assume we have the following “transition” probabilities:</p>
<p><span class="math inline">\(P(S_{t+1}|R_t) = 0.5\)</span></p>
<p><span class="math inline">\(P(R_{t+1}|R_t) = 0.5\)</span></p>
<p><span class="math inline">\(P(R_{t+1}|S_t) = 0.1\)</span></p>
<p><span class="math inline">\(P(S_{t+1}|S_t) = 0.9\)</span></p>
<p>Note the future state of the weather only depends on the current state.</p>
</div>
</div>
</section>
<section id="stationary-distributions" class="level2" style="font-size: 70%;">
<h2 style="font-size: 70%;" class="anchored" data-anchor-id="stationary-distributions">Stationary Distributions</h2>
<p>As we progress through time, the probability of being in certain states (e.g., rainy or sunny) are more likely than others. Over the long run, the distribution will reach an equilibrium with an associated probability of being in each state.</p>
<p>This is known as the <strong>Stationary Distribution</strong>.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
The <strong>stationary distribution</strong> of a Markov chain
</div>
</div>
<div class="callout-body-container callout-body">
<p>The <strong>stationary distribution</strong> of a Markov chain is a probability distribution over the states of the chain that remains unchanged as time progresses.</p>
<p>Mathematically, if <span class="math inline">\(\pi\)</span> represents the stationary distribution (a row vector of probabilities) and <span class="math inline">\(P\)</span> is the transition matrix of the Markov chain, the stationary distribution satisfies the equation:</p>
<p><span class="math display">\[\pi = \pi P\]</span></p>
<p>This means that when the transition matrix <span class="math inline">\(P\)</span> is applied to <span class="math inline">\(\pi\)</span>, the result is still <span class="math inline">\(\pi\)</span>, indicating that the distribution has stabilized and doesn’t change over time.</p>
</div>
</div>
</section>
<section id="creating-the-markov-chain" class="level2" style="font-size: 65%;">
<h2 style="font-size: 65%;" class="anchored" data-anchor-id="creating-the-markov-chain">Creating the Markov Chain</h2>
<div class="columns">
<div class="column" style="width:50%;">
<section id="the-algorithm" class="level3">
<h3 class="anchored" data-anchor-id="the-algorithm">The “algorithm”</h3>
<ol type="1">
<li><p>We have to initialize i.e., a randomly chosen start point of sunny or rainy.</p></li>
<li><p>We can sample the weather, W, (coded as 1 for sunny and 0 for rainy) from a Bernoulli distribution (Binomial with <span class="math inline">\(n=1\)</span>).</p></li>
</ol>
<ul>
<li>The probability distribution will change depending on the current state of the chain, i.e., if W = 1, or W =0.</li>
</ul>
<ol start="3" type="1">
<li>Based on the samples of <span class="math inline">\(W\)</span> we can estimate <span class="math inline">\(P(W=1) = P(S)\)</span> and <span class="math inline">\(P(W=0) = P(R)\)</span>.</li>
</ol>
<p>We find after enough iterations (samples) <span class="math inline">\(P(S) = 0.83\)</span>.</p>
</section>
</div><div class="column" style="width:50%;">
<section id="r-code" class="level3">
<h3 class="anchored" data-anchor-id="r-code">R code</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="co"># 0 = rainy, 1 = sunny</span></span>
<span id="cb1-2"><a href="#cb1-2"></a></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="co"># 1. initialize</span></span>
<span id="cb1-4"><a href="#cb1-4"></a>W_current <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="fl">0.5</span>) </span>
<span id="cb1-5"><a href="#cb1-5"></a></span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="co"># 2. run the Markov Chain</span></span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="co"># number of Monte Carlo sampling interations</span></span>
<span id="cb1-8"><a href="#cb1-8"></a>n_iter <span class="ot">&lt;-</span> <span class="dv">10000</span></span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="co"># save the samples</span></span>
<span id="cb1-10"><a href="#cb1-10"></a>W_new <span class="ot">&lt;-</span> p_sunny <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, n_iter)</span>
<span id="cb1-11"><a href="#cb1-11"></a></span>
<span id="cb1-12"><a href="#cb1-12"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_iter)</span>
<span id="cb1-13"><a href="#cb1-13"></a>{</span>
<span id="cb1-14"><a href="#cb1-14"></a>W_new[i] <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(W_current <span class="sc">==</span> <span class="dv">0</span>,</span>
<span id="cb1-15"><a href="#cb1-15"></a>       <span class="fu">rbinom</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="fl">0.5</span>),</span>
<span id="cb1-16"><a href="#cb1-16"></a>       <span class="fu">rbinom</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="fl">0.9</span>))</span>
<span id="cb1-17"><a href="#cb1-17"></a></span>
<span id="cb1-18"><a href="#cb1-18"></a>W_current <span class="ot">=</span> W_new[i]</span>
<span id="cb1-19"><a href="#cb1-19"></a></span>
<span id="cb1-20"><a href="#cb1-20"></a><span class="co"># 3. get the probability of sunny</span></span>
<span id="cb1-21"><a href="#cb1-21"></a>p_sunny[i] <span class="ot">&lt;-</span> <span class="fu">sum</span>(W_new, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)<span class="sc">/</span>i</span>
<span id="cb1-22"><a href="#cb1-22"></a></span>
<span id="cb1-23"><a href="#cb1-23"></a>}</span>
<span id="cb1-24"><a href="#cb1-24"></a></span>
<span id="cb1-25"><a href="#cb1-25"></a><span class="fu">plot</span>(p_sunny, <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">xlab =</span> <span class="st">"Iteration"</span>, <span class="at">ylab =</span> <span class="st">"P(S)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</div>
</div>
</section>
<section id="mcmc-the-metropolis-algorithm" class="level2" style="font-size: 70%;">
<h2 style="font-size: 70%;" class="anchored" data-anchor-id="mcmc-the-metropolis-algorithm">MCMC: The Metropolis Algorithm</h2>
<ul>
<li><p>Suppose we have a target distribution <span class="math inline">\(p(\theta|y)\)</span> from which we would like to generate a representative sample.</p></li>
<li><p>Sample values from the target distribution can be generated by taking a random walk through the parameter space.</p></li>
</ul>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
The metropolis algorithm
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ol start="0" type="1">
<li><p>Start at some arbitrary parameter value (initial value).</p></li>
<li><p>Propose a move to a new value in the parameter space.</p></li>
<li><p>Calculate the acceptance ratio <span class="math inline">\(r = min \bigg(1, \frac{ p(y|\theta_{pro})p(\theta_{pro})}{p(y|\theta_{cur})p(\theta_{cur})}\bigg)\)</span>.</p></li>
<li><p>Draw a random number, <span class="math inline">\(u\)</span> between 0 and 1. If <span class="math inline">\(u &lt; r\)</span> then the move is accepted.</p></li>
<li><p>Repeat until a representative sample from the target distribution has been generated (more on this later).</p></li>
</ol>
</div>
</div>
</div>
</section>
<section id="metropolis-algorithm-for-the-happiness-example" class="level2" style="font-size: 60%;">
<h2 style="font-size: 60%;" class="anchored" data-anchor-id="metropolis-algorithm-for-the-happiness-example">Metropolis Algorithm for the Happiness example</h2>
<p>Recall for the Happiness example: n = 20 women, y = 14 women reported being happy.</p>
<div class="columns">
<div class="column" style="width:50%;">
<section id="the-metropolis-algorithm-1" class="level3">
<h3 class="anchored" data-anchor-id="the-metropolis-algorithm-1">The Metropolis algorithm</h3>
<p><span class="math inline">\(y \sim Binomial(n = 20, \theta)\)</span></p>
<p><span class="math inline">\(\theta|a,b \sim Beta(a = 1 ,b = 1)\)</span></p>
<ol start="0" type="1">
<li><p>Let’s initialise using <span class="math inline">\(\theta_{cur}\)</span> = 0.5</p></li>
<li><p>Propose a new move using a Normal proposal distribution such that <span class="math inline">\(\theta_{pro} = \theta_{cur} + N(0,\sigma)\)</span></p></li>
<li><p><span class="math inline">\(r = \text{min} \bigg(1, \frac{ dbinom(y,n,\theta_{pro})dbeta(\theta_{pro},a,b)}{dbinom(y,n,\theta_{cur})dbeta(\theta_{cur},a,b)}\bigg)\)</span></p></li>
<li><p>Compare <span class="math inline">\(u \sim Uniform(0,1)\)</span> with <span class="math inline">\(r\)</span> and accept move if <span class="math inline">\(u &lt; r\)</span></p></li>
<li><p>Repeat</p></li>
</ol>
<p>Visualise the samples and look for a “fuzzy caterpiller” 🐛</p>
</section>
</div><div class="column" style="width:50%;">
<section id="r-code-1" class="level3">
<h3 class="anchored" data-anchor-id="r-code-1">R code</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="co"># data </span></span>
<span id="cb2-2"><a href="#cb2-2"></a>y <span class="ot">&lt;-</span> <span class="dv">14</span>; N <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="co"># beta prior parameters</span></span>
<span id="cb2-4"><a href="#cb2-4"></a>a <span class="ot">&lt;-</span> <span class="dv">1</span>; b <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="co"># number of samples to generate</span></span>
<span id="cb2-6"><a href="#cb2-6"></a>n_iter <span class="ot">&lt;-</span> <span class="dv">10000</span></span>
<span id="cb2-7"><a href="#cb2-7"></a></span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="co"># 0. </span></span>
<span id="cb2-9"><a href="#cb2-9"></a>theta_cur <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, n_iter)</span>
<span id="cb2-10"><a href="#cb2-10"></a>theta_cur[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb2-11"><a href="#cb2-11"></a></span>
<span id="cb2-12"><a href="#cb2-12"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(n_iter<span class="dv">-1</span>)){</span>
<span id="cb2-13"><a href="#cb2-13"></a><span class="co"># 1.</span></span>
<span id="cb2-14"><a href="#cb2-14"></a>theta_pro <span class="ot">&lt;-</span> theta_cur[i] <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="at">sd =</span> <span class="fl">0.2</span>)</span>
<span id="cb2-15"><a href="#cb2-15"></a><span class="co"># 2. </span></span>
<span id="cb2-16"><a href="#cb2-16"></a><span class="cf">if</span>(theta_pro<span class="sc">&lt;</span><span class="dv">0</span><span class="sc">|</span>theta_pro<span class="sc">&gt;</span><span class="dv">1</span>){r <span class="ot">&lt;-</span> <span class="dv">0</span> } <span class="co"># set to zero if theta outside [0,1]</span></span>
<span id="cb2-17"><a href="#cb2-17"></a><span class="cf">else</span> {</span>
<span id="cb2-18"><a href="#cb2-18"></a>  r <span class="ot">&lt;-</span> </span>
<span id="cb2-19"><a href="#cb2-19"></a><span class="fu">min</span>(<span class="dv">1</span>,<span class="fu">dbinom</span>(<span class="dv">14</span>,<span class="dv">20</span>,theta_pro)<span class="sc">*</span><span class="fu">dbeta</span>(theta_pro,a,b)<span class="sc">/</span></span>
<span id="cb2-20"><a href="#cb2-20"></a>      <span class="fu">dbinom</span>(<span class="dv">14</span>,<span class="dv">20</span>,theta_cur[i])<span class="sc">*</span><span class="fu">dbeta</span>(theta_cur[i],a,b))</span>
<span id="cb2-21"><a href="#cb2-21"></a>  }</span>
<span id="cb2-22"><a href="#cb2-22"></a><span class="co"># 3. </span></span>
<span id="cb2-23"><a href="#cb2-23"></a>u <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb2-24"><a href="#cb2-24"></a>accept <span class="ot">&lt;-</span> u <span class="sc">&lt;</span> r</span>
<span id="cb2-25"><a href="#cb2-25"></a>theta_cur[i<span class="sc">+</span><span class="dv">1</span>]<span class="ot">&lt;-</span> <span class="fu">ifelse</span>(accept,theta_pro,theta_cur[i])</span>
<span id="cb2-26"><a href="#cb2-26"></a>} <span class="co"># end i loop</span></span>
<span id="cb2-27"><a href="#cb2-27"></a></span>
<span id="cb2-28"><a href="#cb2-28"></a><span class="fu">plot</span>(theta_cur, <span class="at">type =</span> <span class="st">"l"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</div>
</div>
</section>
<section id="metropolis-algorithm-for-the-happiness-example-1" class="level2" style="font-size: 60%;">
<h2 style="font-size: 60%;" class="anchored" data-anchor-id="metropolis-algorithm-for-the-happiness-example-1">Metropolis Algorithm for the Happiness example</h2>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="4-MCMC_files/figure-html/unnamed-chunk-3-1.gif" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="trace-plot-and-chains-for-theta" class="level2" style="font-size: 70%;">
<h2 style="font-size: 70%;" class="anchored" data-anchor-id="trace-plot-and-chains-for-theta">Trace plot and chains for <span class="math inline">\(\theta\)</span></h2>
<ul>
<li><p>Traceplots provide a visual tool for monitoring convergence of an MCMC chain towards a target distribution (i.e., the posterior).</p></li>
<li><p>In general we look for a stationary plot where the sample values display a random scatter around a mean value.</p></li>
<li><p>We typically initialise MCMC algorithms at 3 different start points to see if all chains end up in (converge to) the same place.</p></li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/mcmc_beta_binom.gif" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
</section>
<section id="metropolis-algorithm-for-the-kid-iq-example" class="level2" style="font-size: 70%;">
<h2 style="font-size: 70%;" class="anchored" data-anchor-id="metropolis-algorithm-for-the-kid-iq-example">Metropolis algorithm for the Kid IQ example</h2>
<p>Recall that data (y) are available on the cognitive test scores of three- and four-year-old children in the USA. The sample contains 434 observations.</p>
<p><span class="math inline">\(y_i|\mu,\sigma^2 \sim N(\mu, \sigma^2)\)</span>. Assume <span class="math inline">\(\sigma^2\)</span> is known where <span class="math inline">\(\sigma = 20.4\)</span></p>
<p><span class="math inline">\(\mu|\mu_0,\sigma_0 \sim N(\mu_0 = 80, \sigma^2_{_0} = 10^2)\)</span></p>
<ol start="0" type="1">
<li><p>Let’s initialise using <span class="math inline">\(\mu_{cur}\)</span> = 80.</p></li>
<li><p>Propose a new move using a Normal proposal distribution such that <span class="math inline">\(\mu_{pro} = \mu_{cur} + N(0,1)\)</span>.</p></li>
<li><p>Calculate the acceptance ratio on the log scale (avoids numerical instability).</p></li>
</ol>
<p><span class="math inline">\(log(r) = \text{min}(0, \sum_i log(dnorm(y_i,\mu_{pro},20.4)) + log(dnorm(\mu_{pro},80,10))\)</span> <span class="math inline">\(- \sum_i log(dnorm(y_i,\mu_{cur},20.4)) - log(dnorm(\mu_{cur},80,10)))\)</span></p>
<ol start="3" type="1">
<li>Compare <span class="math inline">\(u \sim Uniform(0,1)\)</span> with <span class="math inline">\(r\)</span> and accept move if <span class="math inline">\(log(u) &lt; r\)</span>.</li>
</ol>
<p><strong>Task:</strong> Code this in R and produce a trace plot for <span class="math inline">\(\mu\)</span>.</p>
</section>
<section id="bayesian-inference-for-mu-and-sigma-the-kid-iq-example" class="level2" style="font-size: 70%;">
<h2 style="font-size: 70%;" class="anchored" data-anchor-id="bayesian-inference-for-mu-and-sigma-the-kid-iq-example">Bayesian Inference for <span class="math inline">\(\mu\)</span> <u>and</u> <span class="math inline">\(\sigma\)</span> (the Kid IQ example)</h2>
<ul>
<li><p>It is more realistic to assume <span class="math inline">\(\mu\)</span> and <span class="math inline">\(\sigma\)</span> are unknown.</p></li>
<li><p>In this case we need priors for both parameters and we think about them jointly.</p></li>
<li><p>Then from Bayes’ rule we can get the joint posterior <span class="math inline">\(p(\mu, \sigma |y) \propto p(y|\mu, \sigma)p(\mu,\sigma)\)</span></p></li>
<li><p>Problem: most choices of prior will not result in a closed from expression for the posterior.</p></li>
<li><p>Solution: If we can sample from the target (posterior) distribution we can still do inference.</p></li>
<li><p>The Metropolis method is very useful but can be inefficient. Another sampling method that’s often used for models with multiple parameters is <strong>Gibbs sampling.</strong></p></li>
</ul>
</section>
<section id="mcmc-the-gibbs-sampler" class="level2" style="font-size: 70%;">
<h2 style="font-size: 70%;" class="anchored" data-anchor-id="mcmc-the-gibbs-sampler">MCMC: The Gibbs Sampler</h2>
<p>We can use Gibbs Sampling when we can sample directly from the <strong>conditional posterior distributions</strong> for each model parameter.</p>
<p>So instead of trying to sample directly from a joint posterior distribution, we sample parameters sequentially from their complete conditional distributions (conditioning on data as well as all other model parameters).</p>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
The Gibbs sampling algorithm for <span class="math inline">\(\mu\)</span> and <span class="math inline">\(\tau\)</span>
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ol start="0" type="1">
<li><p>Assign initial values to the parameters <span class="math inline">\(\mu^{(1)}\)</span> and <span class="math inline">\(\tau^{(1)}\)</span></p></li>
<li><p>Given starting values <span class="math inline">\(\mu^{(1)}\)</span> and <span class="math inline">\(\tau^{(1)}\)</span>, draw samples s = 2, 3,….,`some large number’ as follows:</p>
<p>1.1. sample <span class="math inline">\(\tau^{(s)}\)</span> from <span class="math inline">\(p(\tau|y,\mu^{(s-1)})\)</span>.</p>
<p>1.2. sample <span class="math inline">\(\mu^{(s)}\)</span> from <span class="math inline">\(p(\mu|y,\tau^{(s)})\)</span></p></li>
<li><p>Repeat and this will (eventually) generate samples from <span class="math inline">\(p(\mu,\sigma|y)\)</span>, which is what we want!</p></li>
</ol>
</div>
</div>
</div>
</section>
<section id="remember-those-complete-conditional-distributions" class="level2" style="font-size: 70%;">
<h2 style="font-size: 70%;" class="anchored" data-anchor-id="remember-those-complete-conditional-distributions">Remember those complete conditional distributions?</h2>
<p>Recall for the Normal likelihood <span class="math inline">\(y_i|\mu,\sigma^2 \sim N(\mu, \sigma^2)\)</span> where <span class="math inline">\(\sigma\)</span> is known and a Normal prior <span class="math inline">\(\mu \sim N(\mu_0, \sigma^2_{_0})\)</span>, we get a posterior for <span class="math inline">\(\mu\)</span> that is also a normal distribution (i.e., we used a conjugate prior)</p>
<p><span class="math display">\[\mu|y \sim N \bigg(\frac{\mu_0/\sigma^2_{0}+ n\bar{y}/\sigma^2}{1/\sigma^2_{0}+n/\sigma^2}, {\frac{1}{1/\sigma^2_{0}+n/\sigma^2}}\bigg)\]</span></p>
<p>Recall for the Normal likelihood <span class="math inline">\(y_i|\mu,\sigma^2 \sim N(\mu, \sigma^2)\)</span> where <span class="math inline">\(\mu\)</span> is known and a Gamma prior <span class="math inline">\(\frac{1}{\sigma^2} = \tau \sim Gamma(a, b)\)</span> we get a posterior for <span class="math inline">\(\tau\)</span> that will also be a gamma distribution</p>
<p><span class="math display">\[\tau|y \sim Gamma \bigg(a + n/2, b + 1/2\sum_{i=1}^n (y_i - \mu)^2\bigg)\]</span></p>
<p>These are the <strong>complete conditionals</strong>. We know the posterior distribution for one parameter conditional on knowning the other parameter(s). Now we can use Gibbs sampling.</p>
</section>
<section id="gibbs-sampling-algorithm-for-the-kid-iq-example" class="level2" style="font-size: 70%;">
<h2 style="font-size: 70%;" class="anchored" data-anchor-id="gibbs-sampling-algorithm-for-the-kid-iq-example">Gibbs sampling algorithm for the Kid IQ example</h2>
<p>Recall data (y) are available on the cognitive test scores of three- and four-year-old children in the USA. The sample contains <span class="math inline">\(n=434\)</span> observations.</p>
<div class="columns">
<div class="column" style="width:50%;">
<p><span class="math inline">\(y \sim Normal(\mu, \sigma^2)\)</span></p>
<p><span class="math inline">\(\mu \sim Normal(80 ,10)\)</span> <span class="math inline">\(1/\sigma^2 = \tau \sim gamma(1 ,1)\)</span></p>
<ol start="0" type="1">
<li><p>Let’s initialise using <span class="math inline">\(\mu^{(1)} = 80, \tau^{(1)} = 1\)</span></p></li>
<li><p>Given starting values <span class="math inline">\(\mu^{(1)}\)</span> and <span class="math inline">\(\tau^{(1)}\)</span>, draw samples s = 2, 3,….,`some large number’ as follows:</p>
<p>1.1. sample <span class="math inline">\(\tau^{(s)}\)</span> from <span class="math inline">\(p(\tau|y,\mu^{(s-1)})\)</span>.</p>
<p>1.2. sample <span class="math inline">\(\mu^{(s)}\)</span> from <span class="math inline">\(p(\mu|y,\tau^{(s)})\)</span></p></li>
<li><p>Repeat and this will (eventually) generate samples from <span class="math inline">\(p(\mu,\sigma|y)\)</span>, which is what we want!</p></li>
</ol>
</div><div class="column" style="width:50%;">
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="do">## Data</span></span>
<span id="cb3-2"><a href="#cb3-2"></a>y <span class="ot">&lt;-</span> kidiq<span class="sc">$</span>kid_score</span>
<span id="cb3-3"><a href="#cb3-3"></a>n <span class="ot">&lt;-</span> <span class="fu">length</span>(y)</span>
<span id="cb3-4"><a href="#cb3-4"></a></span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="do">## Prior parameters </span></span>
<span id="cb3-6"><a href="#cb3-6"></a>mu0 <span class="ot">&lt;-</span> <span class="dv">80</span>; sigma.mu0 <span class="ot">&lt;-</span> <span class="dv">10</span> <span class="co"># for normal prior (for mu)</span></span>
<span id="cb3-7"><a href="#cb3-7"></a>a <span class="ot">&lt;-</span> <span class="dv">1</span>; b <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co"># for gamma prior (for tau)</span></span>
<span id="cb3-8"><a href="#cb3-8"></a></span>
<span id="cb3-9"><a href="#cb3-9"></a>n_iter <span class="ot">&lt;-</span> <span class="dv">10000</span> <span class="do">## choose # iter</span></span>
<span id="cb3-10"><a href="#cb3-10"></a><span class="do">## create objects to store results</span></span>
<span id="cb3-11"><a href="#cb3-11"></a>mu_s <span class="ot">&lt;-</span> tau_s <span class="ot">&lt;-</span> sigma_s <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, n_iter)</span>
<span id="cb3-12"><a href="#cb3-12"></a></span>
<span id="cb3-13"><a href="#cb3-13"></a><span class="do">## 0. Initialise </span></span>
<span id="cb3-14"><a href="#cb3-14"></a>mu_s[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">80</span>; tau_s[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span>; sigma_s[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb3-15"><a href="#cb3-15"></a><span class="do">## define parameters for gamma posterior on tau</span></span>
<span id="cb3-16"><a href="#cb3-16"></a>post.a <span class="ot">=</span> a <span class="sc">+</span> n<span class="sc">/</span><span class="dv">2</span>; post.b <span class="ot">=</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span><span class="sc">*</span>(<span class="fu">sum</span>((y<span class="sc">-</span>mu_s[<span class="dv">1</span>])<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb3-17"><a href="#cb3-17"></a></span>
<span id="cb3-18"><a href="#cb3-18"></a><span class="do">## 1.</span></span>
<span id="cb3-19"><a href="#cb3-19"></a><span class="cf">for</span>(s <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>n_iter){</span>
<span id="cb3-20"><a href="#cb3-20"></a><span class="do">## 1.1 sample from complete conditional for tau</span></span>
<span id="cb3-21"><a href="#cb3-21"></a>tau_s[s] <span class="ot">&lt;-</span> <span class="fu">rgamma</span>(<span class="dv">1</span>,post.a,post.b)</span>
<span id="cb3-22"><a href="#cb3-22"></a>sigma_s[s] <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="dv">1</span><span class="sc">/</span>tau_s[s]) <span class="co"># transform to sigma</span></span>
<span id="cb3-23"><a href="#cb3-23"></a><span class="do">## update posterior parameters for mu</span></span>
<span id="cb3-24"><a href="#cb3-24"></a>mupost.mean <span class="ot">=</span> (mu0<span class="sc">/</span>(sigma.mu0<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> tau_s[s]<span class="sc">*</span>n<span class="sc">*</span><span class="fu">mean</span>(y))<span class="sc">/</span>(<span class="dv">1</span><span class="sc">/</span>(sigma.mu0<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> tau_s[s]<span class="sc">*</span>n)</span>
<span id="cb3-25"><a href="#cb3-25"></a>mupost.sd <span class="ot">=</span> <span class="fu">sqrt</span>(<span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span><span class="sc">/</span>(sigma.mu0<span class="sc">^</span><span class="dv">2</span>)<span class="sc">+</span>tau_s[s]<span class="sc">*</span>n))</span>
<span id="cb3-26"><a href="#cb3-26"></a><span class="do">## 1.2 sample from complete conditional for mu</span></span>
<span id="cb3-27"><a href="#cb3-27"></a>mu_s[s] <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>,mupost.mean,mupost.sd)</span>
<span id="cb3-28"><a href="#cb3-28"></a><span class="do">## update posterior parameters for tau</span></span>
<span id="cb3-29"><a href="#cb3-29"></a>post.a <span class="ot">=</span> a <span class="sc">+</span> n<span class="sc">/</span><span class="dv">2</span></span>
<span id="cb3-30"><a href="#cb3-30"></a>post.b <span class="ot">=</span> b <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span><span class="sc">*</span>(<span class="fu">sum</span>((y<span class="sc">-</span>mu_s[s])<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb3-31"><a href="#cb3-31"></a>} <span class="co"># end s loop</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</section>
<section id="output-from-mcmc" class="level2" style="font-size: 60%;">
<h2 style="font-size: 60%;" class="anchored" data-anchor-id="output-from-mcmc">Output from MCMC</h2>
<p>MCMC samples are not <em>independent</em> draws from a target distribution:</p>
<ul>
<li><p>The first draw is not a random draw from the target distribution and tuning of MCMC parameters may occur at the start of a chain.</p></li>
<li><p>Subsequently, draw s + 1 depends on draw s: the samples may be autocorrelated.</p></li>
</ul>
<p>We can use samples from an MCMC algorithm to do inference but ONLY IF</p>
<ul>
<li><p>We exclude samples from the initial period (burn-in).</p></li>
<li><p>We “wait long enough” to get a set of samples that are representative of the target (posterior). distribution.</p></li>
</ul>
<div class="cell" data-output-location="column-fragment">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a dataset (tibble) of samples</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co"># chose a "burn-in" </span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>n_burnin <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove the first sample from mu_s and sigma_s</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>post_samps <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">sample_index =</span> <span class="dv">1</span><span class="sc">:</span>(n_iter<span class="sc">-</span>n_burnin),</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>                     <span class="at">mu_s =</span> mu_s[<span class="sc">-</span>(<span class="dv">1</span><span class="sc">:</span>n_burnin)], </span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>                     <span class="at">sigma_s =</span> sigma_s[<span class="sc">-</span>(<span class="dv">1</span><span class="sc">:</span>n_burnin)])</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>post_samps</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9,900 × 3
   sample_index  mu_s sigma_s
          &lt;int&gt; &lt;dbl&gt;   &lt;dbl&gt;
 1            1  87.9    20.3
 2            2  86.0    20.2
 3            3  85.0    21.8
 4            4  86.4    18.8
 5            5  86.1    21.3
 6            6  88.0    21.7
 7            7  86.8    21.4
 8            8  86.5    20.3
 9            9  87.6    20.3
10           10  87.5    20.2
# ℹ 9,890 more rows</code></pre>
</div>
</div>
</section>
<section id="output-from-mcmc-trace-plots" class="level2" style="font-size: 60%;">
<h2 style="font-size: 60%;" class="anchored" data-anchor-id="output-from-mcmc-trace-plots">Output from MCMC: trace plots</h2>
<p>We can use trace plots to investigate the MCMC samples/chains for the parameters.</p>
<div class="cell" data-output-location="column-fragment">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Trace plot for mu</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(post_samps, <span class="fu">aes</span>(<span class="at">x =</span> sample_index, mu_s)) <span class="sc">+</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">geom_line</span>(<span class="at">colour =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ggtitle</span>(<span class="st">"Posterior Samples of mu"</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Trace plot for sigma</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(post_samps, <span class="fu">aes</span>(<span class="at">x =</span> sample_index, sigma_s)) <span class="sc">+</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">geom_line</span>(<span class="at">colour =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ggtitle</span>(<span class="st">"Posterior Samples of sigma"</span>)</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>p1;p2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="4-MCMC_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="4-MCMC_files/figure-html/unnamed-chunk-7-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="output-from-mcmc-joint-parameter-plots" class="level2" style="font-size: 60%;">
<h2 style="font-size: 60%;" class="anchored" data-anchor-id="output-from-mcmc-joint-parameter-plots">Output from MCMC: joint parameter plots</h2>
<p>We can visualise the joint posterior distribution of the parameters based on the MCMC samples.</p>
<div class="cell" data-output-location="column-fragment">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a><span class="co"># Scatter plot of mu_s vs. sd_s</span></span>
<span id="cb7-2"><a href="#cb7-2"></a>p3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(post_samps, <span class="fu">aes</span>(<span class="at">x =</span> sigma_s, mu_s)) <span class="sc">+</span></span>
<span id="cb7-3"><a href="#cb7-3"></a>        <span class="fu">geom_point</span>(<span class="at">colour =</span> <span class="st">"blue"</span>) </span>
<span id="cb7-4"><a href="#cb7-4"></a></span>
<span id="cb7-5"><a href="#cb7-5"></a><span class="co"># Contour plot of joint density</span></span>
<span id="cb7-6"><a href="#cb7-6"></a>p4 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(post_samps, <span class="fu">aes</span>(<span class="at">x =</span> sigma_s, <span class="at">y =</span> mu_s)) <span class="sc">+</span> </span>
<span id="cb7-7"><a href="#cb7-7"></a>  <span class="fu">geom_density_2d</span>(<span class="at">colour =</span> <span class="st">"blue"</span>)    </span>
<span id="cb7-8"><a href="#cb7-8"></a></span>
<span id="cb7-9"><a href="#cb7-9"></a>p3;p4</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="4-MCMC_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="4-MCMC_files/figure-html/unnamed-chunk-8-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="output-from-mcmc-density-plots-and-summaries" class="level2" style="font-size: 60%;">
<h2 style="font-size: 60%;" class="anchored" data-anchor-id="output-from-mcmc-density-plots-and-summaries">Output from MCMC: density plots and summaries</h2>
<p>We can visualise and obtain summaries for the marginal posterior distributions of the parameters based on the MCMC samples.</p>
<div class="cell" data-output-location="column-fragment">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Density plot for posterior samples of mu</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>p5 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(post_samps, <span class="fu">aes</span>(<span class="at">x =</span> mu_s)) <span class="sc">+</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>        <span class="fu">geom_density</span>(<span class="at">fill =</span> <span class="st">"lightblue"</span>, </span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">color =</span> <span class="st">"blue"</span>, </span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>                     <span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ggtitle</span>(<span class="st">"Posterior Density of mu"</span>) </span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Mean and credible interval for mu</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>mu_mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(mu_s)</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>mu_ci <span class="ot">&lt;-</span> <span class="fu">quantile</span>(mu_s, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>))</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>p5;<span class="fu">cat</span>(<span class="st">"Mean of Mu:"</span>, mu_mean, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>);<span class="fu">cat</span>(<span class="st">"95% Credible Interval for Mu:"</span>, mu_ci, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="4-MCMC_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Mean of Mu: 86.74137 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>95% Credible Interval for Mu: 84.82647 88.66879 </code></pre>
</div>
</div>
<div class="cell" data-output-location="column-fragment">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>p6 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(post_samps, <span class="fu">aes</span>(<span class="at">x =</span> sigma_s)) <span class="sc">+</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>        <span class="fu">geom_density</span>(<span class="at">fill =</span> <span class="st">"lightblue"</span>, </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>                     <span class="at">color =</span> <span class="st">"blue"</span>, </span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ggtitle</span>(<span class="st">"Posterior Density of sigma"</span>) </span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Mean and credible interval for sigma</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>sigma_mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(sigma_s)</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>sigma_ci <span class="ot">&lt;-</span> <span class="fu">quantile</span>(sigma_s, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>))</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>p6;<span class="fu">cat</span>(<span class="st">"Mean of Sigma:"</span>, sigma_mean, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>);<span class="fu">cat</span>(<span class="st">"95% Credible Interval for Sigma:"</span>, sigma_ci, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="4-MCMC_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Mean of Sigma: 20.39958 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>95% Credible Interval for Sigma: 19.07164 21.79159 </code></pre>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
          // target, if specified
          link.setAttribute("target", "_blank");
          if (link.getAttribute("rel") === null) {
            link.setAttribute("rel", "noopener");
          }
          // default icon
          link.classList.add("external");
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>